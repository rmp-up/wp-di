language: php

php:
  # see http://php.net/supported-versions.php
  - '7.0' # deprecated
  - '7.1' # deprecated
  - '7.2' # Until 30 Nov 2020
  - '7.3' # Until 6 Dec 2021
  - '7.4' # Until 28 Nov 2022

addons:
  apt:
    packages:
      - parallel

env:
  global:
    - COMPOSER_CACHE_DIR=/home/travis/.composer
  matrix:
    # see https://codex.wordpress.org/WordPress_Versions
    # see https://phpunit.de/supported-versions.html
    - WP_VERSION=4.8.*
    - WP_VERSION=5.0.*
    - WP_VERSION=5.2.*
    - WP_VERSION=5.4.*
    - WP_VERSION=5.5.*
    - WP_VERSION=dev-master

matrix:
  include:
    # Intermediate version tests due to unstable SemVer
    #- php: '7.1'
    #  env: WP_VERSION=4.9
    # additional combination among env (as above)
    - php: '5.6'
      env: WP_VERSION=4.8.*
    - php: 'hhvm'
      env: WP_VERSION=5.4.*
    - php: 'nightly'
      env: WP_VERSION=5.4.*
  # in the process to achieve support
  allow_failures:
    - php: '5.6'
    - php: 'hhvm'
    - php: 'nightly'
    - env: WP_VERSION=dev-master
  # Do not wait for allowed failures
  fast_finish: true

services:
  - mysql

cache:
  directories:
    - /home/travis/.composer

before_install:
  - mysql -e 'CREATE DATABASE dev;'
  # ocramius/package-versions:1.2 (for PHP 7.0) needs Composer 1.*
  - "[[ $TRAVIS_PHP_VERSION > '7.0' ]] || composer self-update --1"
  # Disable PHPStan because it gives false-positives PHP < 7.1
  - "[[ $TRAVIS_PHP_VERSION > '7.0' ]] || composer remove --no-update -n --dev phpstan/phpstan"
  # Try supporting other versions
  - "[[ $WP_VERSION != *'dev-master' ]] || composer config minimum-stability dev"
  - "[[ $WP_VERSION != *'dev-master' ]] || composer config prefer-stable true"
  - composer require --update-with-dependencies johnpbloch/wordpress:$WP_VERSION

install:
  - composer install
  # Using WP-CLI instead of Composer because this way we can use the env matrix (above).
  - vendor/bin/wp --allow-root config create --force --dbuser=travis --dbpass="" --dbhost="127.0.0.1" --skip-check
  - vendor/bin/wp --allow-root core install --skip-email
  - for L in etc/*; do ln -s $L; done
  - ln -s etc/.coveralls.yml

script:
  - "[[ $WP_VERSION == *'dev-master' ]] || composer validate --strict --no-check-lock"
  - vendor/bin/phpunit --coverage-clover coverage.xml
  # Code quality checks should not differ among different PHP versions, so we spare runtime here
  - "[[ $TRAVIS_PHP_VERSION != 7.3 ]] || vendor/bin/phpstan analyse lib/"
  - "[[ $TRAVIS_PHP_VERSION != 7.3 ]] || vendor/bin/phpcs --standard=etc/phpcs.xml.dist -s lib/"

after_failure:
  - cat srv/wp-content/debug.log || true
